package no.nav.hjelpemidler.soknad.mottak.util

import com.fasterxml.jackson.databind.JsonNode
import kotlinx.coroutines.runBlocking
import no.nav.hjelpemidler.soknad.mottak.Configuration
import no.nav.hjelpemidler.soknad.mottak.Profile
import no.nav.hjelpemidler.soknad.mottak.client.hmdb.HjelpemiddeldatabaseClient
import no.nav.hjelpemidler.soknad.mottak.util.slack.PostToSlack

object AutoGenerateDocumentTitle {
    private val defaultTitle = "Søknad om hjelpemidler"

    fun generateTitle(soknad: JsonNode): String {
        if (Configuration.application.profile == Profile.LOCAL) return defaultTitle

        val hjelpemidlerListe = soknad["soknad"]["hjelpemidler"]["hjelpemiddelListe"]
        val hmsnrs = hjelpemidlerListe.mapNotNull { it["hmsNr"].asText() }.filter { it.isNotEmpty() }.toSet()
        val isokategorier = runBlocking {
            HjelpemiddeldatabaseClient.hentIsokortnavnForProdukterMedHmsnrs(hmsnrs)
        }

        val title = isokategorier.mapNotNull { it.isokortnavn }.filter { it.isNotEmpty() }.toSet().joinToString(separator = ", ")
        if (title.isEmpty()) return defaultTitle

        val dokumentbeskrivelse = "Søknad om: ${title.lowercase()}"
        PostToSlack().post(dokumentbeskrivelse)
        return dokumentbeskrivelse
    }
}
